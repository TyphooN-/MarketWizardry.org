<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="TyphooN">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarketWizardry.org | Financial Calculator Suite</title>
    <link rel="canonical" href="https://marketwizardry.org/calculator.html">
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
    <!-- Standard Meta Tags -->
    <meta name="description" content="Multi-modal financial calculator suite for VaR, stop losses, position sizing, and portfolio risk management. Mathematical precision for your trading disasters.">
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Financial Calculator Suite - MarketWizardry.org">
    <meta property="og:description" content="Multi-modal financial calculator suite for VaR, stop losses, position sizing, and portfolio risk management. Mathematical precision for your trading disasters.">
    <meta property="og:url" content="https://marketwizardry.org/calculator.html">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Market Wizardry">
    <meta property="og:image" content="https://marketwizardry.org/img/xicojam-1924524951521853846-prompt-video1-mod-mod.webp">
    <meta property="og:image:alt" content="MarketWizardry.org - Financial Trading Tools">
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Financial Calculator Suite - MarketWizardry.org">
    <meta name="twitter:description" content="Multi-modal financial calculator suite for VaR, stop losses, position sizing, and portfolio risk management. Mathematical precision for your trading disasters.">
    <meta name="twitter:site" content="@MarketW1zardry">
    <meta name="twitter:creator" content="@MarketW1zardry">
    <meta name="twitter:image" content="https://marketwizardry.org/img/xicojam-1924524951521853846-prompt-video1-mod-mod.webp">
    <script>
        // Redirect to index.html if accessed directly (not in iframe)
        if (window === window.top) {
            // Small delay to ensure viewport takes effect on mobile
            setTimeout(() => {
                const currentPath = window.location.pathname;
                if (currentPath.includes('/blog/') || currentPath.includes('/nft-gallery/')) {
                    // For blog posts and NFT galleries, pass full path
                    const fullPath = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
                    window.location.href = `/?page=${encodeURIComponent(fullPath)}`;
                } else {
                    // For main pages, redirect with page parameter
                    const currentPage = currentPath.split('/').pop().replace('.html', '');
                    window.location.href = `/?page=${currentPage}`;
                }
            }, 100);
        }
    </script>
    <style>
        body {
            background-color: #000;
            color: #00ff00;
            font-family: "Courier New", monospace;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            padding-bottom: 10px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        h2 {
            color: #00ff00;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .calculator-card {
            background-color: #001100;
            border: 2px solid rgba(0, 255, 0, 0.5);
            padding: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .calculator-card:hover {
            background-color: #002200;
            border-color: #00ff00;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3);
        }
        .calculator-card.active {
            background-color: #002200;
            border-color: #00ff00;
        }
        .calculator-content {
            display: none;
            background-color: #001100;
            border: 2px solid #00ff00;
            padding: 25px;
            margin-top: 20px;
            border-radius: 8px;
        }
        .calculator-content.active {
            display: block;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            color: #00cc00;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: "Courier New", monospace;
            border-radius: 4px;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #00cc00;
            box-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        .calculate-btn {
            background-color: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            font-family: "Courier New", monospace;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        .calculate-btn:hover {
            background-color: #004400;
            transform: scale(1.02);
        }
        .result-box {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            display: none;
        }
        .result-box.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-label {
            color: #00cc00;
            font-weight: bold;
        }
        .result-value {
            color: #00ff00;
            font-size: 1.2em;
            font-weight: bold;
        }
        .warning-text {
            color: #ffaa00;
            font-size: 0.9em;
            margin-top: 10px;
            font-style: italic;
        }
        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .portfolio-table th, .portfolio-table td {
            border: 1px solid #00ff00;
            padding: 8px;
            text-align: left;
        }
        .portfolio-table th {
            background-color: #003300;
            color: #00ff00;
        }
        .portfolio-table td {
            background-color: #001100;
        }
        .add-position-btn {
            background-color: #002200;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 10px;
            font-family: "Courier New", monospace;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 10px;
        }
        .remove-btn {
            background-color: #330000;
            color: #ff0000;
            border: 1px solid #ff0000;
            padding: 2px 6px;
            font-family: "Courier New", monospace;
            cursor: pointer;
            border-radius: 2px;
            font-size: 0.8em;
        }
        .quick-symbol-btn {
            background-color: #002200;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 8px;
            font-family: "Courier New", monospace;
            cursor: pointer;
            border-radius: 2px;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .quick-symbol-btn:hover {
            background-color: #00ff00;
            color: #000000;
        }
        .crt-divider {
            width: 100%;
            height: 1px;
            background-color: #00ff00;
            animation: scan 1s infinite;
            margin: 30px 0;
        }
        @keyframes scan {
            0% { opacity: 1; width: 0%; }
            50% { opacity: 0.5; }
            100% { opacity: 1; width: 100%; }
        }
        .flavor-text {
            color: #00ff00;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            font-style: italic;
            font-weight: bold;
            opacity: 0.9;
            animation: flicker 1s infinite;
        }
        @keyframes flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Financial Calculator Suite</h1>
        <div class="crt-divider"></div>
        <div class="flavor-text">Mathematical precision for financial degenerates who need calculated confirmation of their doom.</div>
        <div class="crt-divider"></div>

        <!-- Calculator Selection Grid -->
        <div class="calculator-grid">
            <div class="calculator-card" onclick="selectCalculator('stoploss')">
                <h2>üõë Stop Loss Calculator</h2>
                <p>Calculate optimal stop loss levels based on volatility, risk tolerance, and position size. Because knowing exactly where you'll get stopped out is half the battle.</p>
            </div>

            <div class="calculator-card" onclick="selectCalculator('position')">
                <h2>‚öñÔ∏è Position Size Calculator</h2>
                <p>Determine position sizes based on account risk, volatility, and stop loss levels. Scientific precision for your inevitable losses.</p>
            </div>

            <div class="calculator-card" onclick="selectCalculator('portfolio')">
                <h2>üìä Portfolio VaR Calculator</h2>
                <p>Calculate portfolio Value at Risk using multiple positions with correlation adjustments. Watch your diversification fail mathematically.</p>
            </div>

            <div class="calculator-card" onclick="selectCalculator('riskreturn')">
                <h2>üìà Risk/Return Calculator</h2>
                <p>Analyze risk-adjusted returns, Sharpe ratios, and drawdown metrics. Quantify exactly how much you're underperforming.</p>
            </div>

            <div class="calculator-card" onclick="selectCalculator('lookup')">
                <h2>üîç Symbol Lookup Tool</h2>
                <p>Search comprehensive VaR, ATR, and market data from our explorer databases. Real-time data for informed trading decisions.</p>
            </div>
        </div>

        <!-- Stop Loss Calculator -->
        <div id="stoploss-calculator" class="calculator-content">
            <h2>üõë Stop Loss Calculator</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="input-group">
                        <label for="sl-symbol">Symbol (optional - for auto-fill)</label>
                        <input type="text" id="sl-symbol" placeholder="AAPL, CC, AMD..." style="text-transform: uppercase;" onchange="autoFillStopLossData()">
                    </div>
                    <div class="input-group">
                        <label for="sl-entry-price">Entry Price ($)</label>
                        <input type="number" id="sl-entry-price" step="0.01" placeholder="100.00">
                    </div>
                    <div class="input-group">
                        <label for="sl-position-size">Position Size (shares)</label>
                        <input type="number" id="sl-position-size" placeholder="100">
                    </div>
                    <div class="input-group">
                        <label for="sl-risk-percent">Risk Percentage (%)</label>
                        <input type="number" id="sl-risk-percent" step="0.1" placeholder="2.0">
                    </div>
                    <div class="input-group">
                        <label for="sl-timeframe">Trading Timeframe</label>
                        <select id="sl-timeframe" onchange="autoFillStopLossData()">
                            <option value="M5">5 Minutes (Scalping)</option>
                            <option value="M15">15 Minutes (Scalping)</option>
                            <option value="H1">1 Hour (Intraday)</option>
                            <option value="H4">4 Hours (Swing)</option>
                            <option value="D1" selected>Daily (Position)</option>
                            <option value="W1">Weekly (Long-term)</option>
                            <option value="MN1">Monthly (Investment)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="sl-atr">ATR (Average True Range)</label>
                        <input type="number" id="sl-atr" step="0.01" placeholder="2.50">
                        <small style="color: #00aa00; font-size: 0.8em;">üìä Use ATR from your selected timeframe for best results</small>
                    </div>
                    <button class="calculate-btn" onclick="calculateStopLoss()">Calculate Stop Loss</button>
                </div>
                <div id="sl-results" class="result-box">
                    <div class="result-label">Stop Loss Calculations:</div>
                    <div id="sl-output"></div>
                </div>
            </div>
        </div>

        <!-- Position Size Calculator -->
        <div id="position-calculator" class="calculator-content">
            <h2>‚öñÔ∏è Position Size Calculator</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="input-group">
                        <label for="ps-account-size">Account Size ($)</label>
                        <input type="number" id="ps-account-size" placeholder="10000">
                    </div>
                    <div class="input-group">
                        <label for="ps-risk-percent">Risk per Trade (%)</label>
                        <input type="number" id="ps-risk-percent" step="0.1" placeholder="1.0">
                    </div>
                    <div class="input-group">
                        <label for="ps-entry-price">Entry Price ($)</label>
                        <input type="number" id="ps-entry-price" step="0.01" placeholder="100.00">
                    </div>
                    <div class="input-group">
                        <label for="ps-stop-loss">Stop Loss Price ($)</label>
                        <input type="number" id="ps-stop-loss" step="0.01" placeholder="95.00">
                    </div>
                    <button class="calculate-btn" onclick="calculatePositionSize()">Calculate Position Size</button>
                </div>
                <div id="ps-results" class="result-box">
                    <div class="result-label">Position Size Calculations:</div>
                    <div id="ps-output"></div>
                </div>
            </div>
        </div>

        <!-- Portfolio VaR Calculator -->
        <div id="portfolio-calculator" class="calculator-content">
            <h2>üìä Portfolio VaR Calculator</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="input-group">
                    <label for="pf-confidence">Confidence Level (%)</label>
                    <select id="pf-confidence">
                        <option value="95">95%</option>
                        <option value="99">99%</option>
                        <option value="99.9">99.9%</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="pf-time-horizon">Time Horizon (days)</label>
                    <select id="pf-time-horizon">
                        <option value="1">1 Day</option>
                        <option value="5">5 Days</option>
                        <option value="10">10 Days</option>
                        <option value="22">1 Month</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label for="symbol-lookup">Symbol Lookup (Real VaR Data)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="symbol-lookup" placeholder="Enter symbol (e.g., AAPL, MSFT)" style="flex: 1;">
                    <button class="calculate-btn" onclick="lookupSymbol()" style="margin-top: 0; padding: 8px 15px;">Lookup VaR</button>
                </div>
                <div id="symbol-info" style="margin-top: 10px; padding: 10px; background: #001100; border: 1px solid #00ff00; display: none; border-radius: 4px;">
                    <div id="symbol-details"></div>
                </div>
            </div>

            <h3>Portfolio Positions</h3>
            <table class="portfolio-table" id="portfolio-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Shares</th>
                        <th>Price ($)</th>
                        <th>Value ($)</th>
                        <th>VaR ($)</th>
                        <th>Weight (%)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="portfolio-positions">
                    <tr>
                        <td><input type="text" placeholder="AAPL" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                        <td><input type="number" placeholder="100" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                        <td><input type="number" placeholder="150.00" step="0.01" style="width: 70px;" onchange="updatePositionValue(this)"></td>
                        <td class="value-display">-</td>
                        <td class="var-display">-</td>
                        <td class="weight-display">-</td>
                        <td><button class="remove-btn" onclick="removePosition(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button class="add-position-btn" onclick="addPosition()">+ Add Position</button>
            <button class="calculate-btn" onclick="calculatePortfolioVaR()">Calculate Portfolio VaR</button>

            <div id="pf-results" class="result-box">
                <div class="result-label">Portfolio VaR Results:</div>
                <div id="pf-output"></div>
            </div>
        </div>

        <!-- Risk/Return Calculator -->
        <div id="riskreturn-calculator" class="calculator-content">
            <h2>üìà Risk/Return Calculator</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="input-group">
                        <label for="rr-returns">Returns (% per period, comma-separated)</label>
                        <textarea id="rr-returns" style="height: 100px; resize: vertical;" placeholder="2.5, -1.2, 3.1, 0.8, -0.5, 1.9, -2.1"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="rr-risk-free">Risk-Free Rate (% annually)</label>
                        <input type="number" id="rr-risk-free" step="0.01" placeholder="3.5">
                    </div>
                    <div class="input-group">
                        <label for="rr-periods">Periods per Year</label>
                        <select id="rr-periods">
                            <option value="252">Daily (252)</option>
                            <option value="52">Weekly (52)</option>
                            <option value="12">Monthly (12)</option>
                        </select>
                    </div>
                    <button class="calculate-btn" onclick="calculateRiskReturn()">Calculate Metrics</button>
                </div>
                <div id="rr-results" class="result-box">
                    <div class="result-label">Risk/Return Metrics:</div>
                    <div id="rr-output"></div>
                </div>
            </div>
        </div>

        <!-- Symbol Lookup Tool -->
        <div id="lookup-calculator" class="calculator-content">
            <h2>üîç Symbol Lookup Tool</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div class="input-group">
                        <label for="lookup-symbol">Symbol Search</label>
                        <input type="text" id="lookup-symbol" placeholder="Enter symbol (e.g., AAPL, CC, AMD)" style="text-transform: uppercase;" onchange="performSymbolLookup()">
                    </div>
                    <div class="input-group">
                        <label for="lookup-filter">Filter by Sector (optional)</label>
                        <select id="lookup-filter" onchange="filterSymbols()">
                            <option value="">All Sectors</option>
                            <option value="Technology">Technology</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Financial">Financial</option>
                            <option value="Consumer Cyclical">Consumer Cyclical</option>
                            <option value="Consumer Defensive">Consumer Defensive</option>
                            <option value="Industrials">Industrials</option>
                            <option value="Communication Services">Communication Services</option>
                            <option value="Energy">Energy</option>
                            <option value="Basic Materials">Basic Materials</option>
                            <option value="Real Estate">Real Estate</option>
                            <option value="ETF">ETF</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Quick Symbol Search</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 5px;">
                            <button class="quick-symbol-btn" onclick="quickLookup('AAPL')">AAPL</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('MSFT')">MSFT</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('GOOGL')">GOOGL</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('AMZN')">AMZN</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('TSLA')">TSLA</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('NVDA')">NVDA</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('CC')">CC</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('AMD')">AMD</button>
                            <button class="quick-symbol-btn" onclick="quickLookup('ADBE')">ADBE</button>
                        </div>
                    </div>
                    <button class="calculate-btn" onclick="showAllSymbols()">Show All Available Symbols</button>
                </div>
                <div id="lookup-results" class="result-box">
                    <div class="result-label">Symbol Information:</div>
                    <div id="lookup-output">Enter a symbol to see comprehensive market data including VaR, ATR, price, and sector information.</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let activeCalculator = null;

        function selectCalculator(calculatorType) {
            // Hide all calculators
            const calculators = document.querySelectorAll('.calculator-content');
            calculators.forEach(calc => calc.classList.remove('active'));

            // Remove active class from all cards
            const cards = document.querySelectorAll('.calculator-card');
            cards.forEach(card => card.classList.remove('active'));

            // Show selected calculator
            document.getElementById(calculatorType + '-calculator').classList.add('active');

            // Add active class to selected card
            event.currentTarget.classList.add('active');

            activeCalculator = calculatorType;
        }

        function autoFillStopLossData() {
            const symbol = document.getElementById('sl-symbol').value.toUpperCase().trim();
            const timeframe = document.getElementById('sl-timeframe').value;

            if (symbol && varData[symbol]) {
                const data = varData[symbol];

                // Auto-fill price if not already filled
                const priceField = document.getElementById('sl-entry-price');
                if (!priceField.value || priceField.value == 0) {
                    priceField.value = data.price;
                }

                // Auto-fill ATR based on timeframe
                const atrField = document.getElementById('sl-atr');
                let atrValue = null;

                if (timeframe === 'D1' && data.atr_d1) {
                    atrValue = data.atr_d1;
                } else if (timeframe === 'W1' && data.atr_w1) {
                    atrValue = data.atr_w1;
                } else if (timeframe === 'MN1' && data.atr_mn1) {
                    atrValue = data.atr_mn1;
                } else if (data.atr_d1) {
                    // Default to daily ATR for shorter timeframes
                    atrValue = data.atr_d1;
                }

                if (atrValue) {
                    atrField.value = atrValue.toFixed(6);
                }

                // Show a small notification
                const atrLabel = document.querySelector('label[for="sl-atr"]');
                const originalText = atrLabel.innerHTML;
                atrLabel.innerHTML = `ATR (${timeframe}) - Auto-filled for ${symbol} ‚úì`;
                atrLabel.style.color = '#00ff00';

                setTimeout(() => {
                    atrLabel.innerHTML = originalText;
                    atrLabel.style.color = '';
                }, 3000);
            }
        }

        function calculateStopLoss() {
            const entryPrice = parseFloat(document.getElementById('sl-entry-price').value);
            const positionSize = parseInt(document.getElementById('sl-position-size').value);
            const riskPercent = parseFloat(document.getElementById('sl-risk-percent').value);
            const atr = parseFloat(document.getElementById('sl-atr').value);
            const timeframe = document.getElementById('sl-timeframe').value;

            if (!entryPrice || !positionSize || !riskPercent) {
                alert('Please fill in all required fields');
                return;
            }

            const positionValue = entryPrice * positionSize;
            const riskAmount = positionValue * (riskPercent / 100);
            const riskPerShare = riskAmount / positionSize;

            // Timeframe-specific ATR multiplier recommendations
            const timeframeData = {
                'M5': {
                    multipliers: [0.5, 1.0, 1.5],
                    recommended: 1.0,
                    description: 'Scalping - Tight stops for quick exits',
                    notes: 'Very tight stops due to noise. Consider using tick-based stops.'
                },
                'M15': {
                    multipliers: [0.8, 1.2, 2.0],
                    recommended: 1.2,
                    description: 'Short-term Scalping - Balance between noise and movement',
                    notes: 'Still susceptible to market noise but allows for small moves.'
                },
                'H1': {
                    multipliers: [1.0, 1.5, 2.5],
                    recommended: 1.5,
                    description: 'Intraday Trading - Standard intraday volatility buffer',
                    notes: 'Good balance for hourly price action and trend following.'
                },
                'H4': {
                    multipliers: [1.5, 2.0, 3.0],
                    recommended: 2.0,
                    description: 'Swing Trading - Medium-term position holding',
                    notes: 'Allows for normal market fluctuations while protecting capital.'
                },
                'D1': {
                    multipliers: [2.0, 2.5, 3.5],
                    recommended: 2.5,
                    description: 'Daily Position Trading - Standard volatility protection',
                    notes: 'Classic 2-3x ATR for daily timeframe trend following.'
                },
                'W1': {
                    multipliers: [2.5, 3.0, 4.0],
                    recommended: 3.0,
                    description: 'Weekly Long-term - Wider stops for major moves',
                    notes: 'Accommodates weekly volatility and longer-term trends.'
                },
                'MN1': {
                    multipliers: [3.0, 4.0, 5.0],
                    recommended: 4.0,
                    description: 'Monthly Investment - Maximum trend capture',
                    notes: 'Very wide stops for long-term investment positions.'
                }
            };

            const tfData = timeframeData[timeframe];
            const percentageStop = entryPrice - riskPerShare;

            let output = `
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Position Value:</div>
                    <div class="result-value">$${positionValue.toLocaleString()}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Maximum Risk Amount:</div>
                    <div class="result-value">$${riskAmount.toFixed(2)}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Risk-Based Stop Loss:</div>
                    <div class="result-value">$${percentageStop.toFixed(2)} (${((entryPrice - percentageStop) / entryPrice * 100).toFixed(2)}% below entry)</div>
                </div>
            `;

            // Add timeframe-specific recommendations
            output += `
                <div style="margin: 20px 0; padding: 15px; background: rgba(0,255,0,0.1); border-left: 3px solid #00ff00;">
                    <h4 style="color: #00ff00; margin: 0 0 10px 0;">üìä ${timeframe} Timeframe Recommendations</h4>
                    <div style="color: #00cc00; margin-bottom: 8px;"><strong>${tfData.description}</strong></div>
                    <div style="color: #00aa00; font-size: 0.9em; margin-bottom: 10px;">${tfData.notes}</div>
                </div>
            `;

            if (atr) {
                output += `<h4 style="color: #00ff00; margin: 15px 0 10px 0;">ATR-Based Stop Loss Options (${timeframe}):</h4>`;

                tfData.multipliers.forEach((multiplier, index) => {
                    const atrStop = entryPrice - (atr * multiplier);
                    const isRecommended = multiplier === tfData.recommended;
                    const label = index === 0 ? 'Conservative' : index === 1 ? 'Balanced' : 'Aggressive';
                    const style = isRecommended ? 'background: rgba(0,255,0,0.2); border: 1px solid #00ff00; padding: 8px; border-radius: 4px;' : '';

                    output += `
                        <div style="margin-bottom: 10px; ${style}">
                            <div class="result-label">${label} (${multiplier}x ATR)${isRecommended ? ' ‚≠ê RECOMMENDED' : ''}:</div>
                            <div class="result-value">$${atrStop.toFixed(2)} (${((entryPrice - atrStop) / entryPrice * 100).toFixed(2)}% below entry)</div>
                            <div style="color: #00aa00; font-size: 0.8em;">Risk per share: $${(entryPrice - atrStop).toFixed(2)} | Total risk: $${((entryPrice - atrStop) * positionSize).toFixed(2)}</div>
                        </div>
                    `;
                });

                // Add comparison with risk-based stop
                const recommendedStop = entryPrice - (atr * tfData.recommended);
                const riskBasedRisk = (entryPrice - percentageStop) * positionSize;
                const atrBasedRisk = (entryPrice - recommendedStop) * positionSize;

                output += `
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00;">
                        <h4 style="color: #ffff00; margin: 0 0 8px 0;">üìã Stop Loss Comparison</h4>
                        <div style="color: #cccc00;">
                            Risk-based (${riskPercent}%): $${riskBasedRisk.toFixed(2)} risk<br>
                            ATR-based (${tfData.recommended}x): $${atrBasedRisk.toFixed(2)} risk<br>
                            <strong>Difference: $${Math.abs(riskBasedRisk - atrBasedRisk).toFixed(2)} ${riskBasedRisk > atrBasedRisk ? '(ATR tighter)' : '(ATR wider)'}</strong>
                        </div>
                    </div>
                `;
            } else {
                output += `
                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,165,0,0.1); border: 1px solid #ffa500;">
                        <div style="color: #ff8800;">üí° <strong>Add ATR value to see ${timeframe} timeframe recommendations!</strong></div>
                        <div style="color: #cc6600; font-size: 0.9em; margin-top: 5px;">
                            Recommended multiplier for ${timeframe}: ${tfData.recommended}x ATR<br>
                            ${tfData.description}
                        </div>
                    </div>
                `;
            }

            output += `
                <div class="warning-text" style="margin-top: 15px;">
                    ‚ö†Ô∏è Stop Loss Guidelines:<br>
                    ‚Ä¢ Stop losses don't guarantee execution at your desired price during gaps<br>
                    ‚Ä¢ Consider using ATR from your actual trading timeframe for best results<br>
                    ‚Ä¢ Shorter timeframes need tighter stops but higher win rates<br>
                    ‚Ä¢ Longer timeframes allow wider stops but require more patience
                </div>
            `;

            document.getElementById('sl-output').innerHTML = output;
            document.getElementById('sl-results').classList.add('show');
        }

        function calculatePositionSize() {
            const accountSize = parseFloat(document.getElementById('ps-account-size').value);
            const riskPercent = parseFloat(document.getElementById('ps-risk-percent').value);
            const entryPrice = parseFloat(document.getElementById('ps-entry-price').value);
            const stopLoss = parseFloat(document.getElementById('ps-stop-loss').value);

            if (!accountSize || !riskPercent || !entryPrice || !stopLoss) {
                alert('Please fill in all required fields');
                return;
            }

            const riskAmount = accountSize * (riskPercent / 100);
            const riskPerShare = Math.abs(entryPrice - stopLoss);
            const positionSize = Math.floor(riskAmount / riskPerShare);
            const positionValue = positionSize * entryPrice;
            const actualRisk = positionSize * riskPerShare;

            const output = `
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Risk Amount:</div>
                    <div class="result-value">$${riskAmount.toFixed(2)}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Risk per Share:</div>
                    <div class="result-value">$${riskPerShare.toFixed(2)}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Recommended Position Size:</div>
                    <div class="result-value">${positionSize.toLocaleString()} shares</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Position Value:</div>
                    <div class="result-value">$${positionValue.toLocaleString()}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Actual Risk:</div>
                    <div class="result-value">$${actualRisk.toFixed(2)} (${(actualRisk/accountSize*100).toFixed(2)}% of account)</div>
                </div>
                <div class="warning-text">‚ö†Ô∏è This assumes perfect execution at your stop loss price. Market gaps can increase actual losses.</div>
            `;

            document.getElementById('ps-output').innerHTML = output;
            document.getElementById('ps-results').classList.add('show');
        }

        // Comprehensive Real Data from Darwinex Live Stocks (2025-09-15) with ATR values
        const varData = {
            'AAL': { var: 0.528972, price: 12.53, sector: 'Industrials', description: 'American Airlines Group Inc', atr_d1: 0.432143, atr_w1: 1.08, atr_mn1: 2.597857 },
            'ACHC': { var: 1.247911, price: 21.47, sector: 'Healthcare', description: 'Acadia Healthcare Co Inc', atr_d1: 1.112857, atr_w1: 2.4, atr_mn1: 10.252857 },
            'ADBE': { var: 8.943352, price: 347.35, sector: 'Technology', description: 'Adobe Inc', atr_d1: 9.33, atr_w1: 21.232143, atr_mn1: 58.496429 },
            'ADI': { var: 7.073842, price: 244.78, sector: 'Technology', description: 'Analog Devices Inc', atr_d1: 4.459286, atr_w1: 12.482143, atr_mn1: 30.38 },
            'ADP': { var: 5.123173, price: 290.93, sector: 'Industrials', description: 'Automatic Data Processing Inc', atr_d1: 4.977143, atr_w1: 10.465714, atr_mn1: 24.563571 },
            'ADSK': { var: 11.540629, price: 321.41, sector: 'Technology', description: 'Autodesk Inc', atr_d1: 8.117857, atr_w1: 16.702857, atr_mn1: 34.462857 },
            'AKAM': { var: 1.966232, price: 76.37, sector: 'Technology', description: 'Akamai Technologies Inc', atr_d1: 1.868571, atr_w1: 3.851429, atr_mn1: 11.845714 },
            'ALGN': { var: 5.577438, price: 131.43, sector: 'Healthcare', description: 'Align Technology Inc', atr_d1: 4.582143, atr_w1: 17.219286, atr_mn1: 40.682857 },
            'ALNY': { var: 14.139684, price: 462.59, sector: 'Healthcare', description: 'Alnylam Pharmaceuticals Inc', atr_d1: 12.677143, atr_w1: 25.139286, atr_mn1: 53.282143 },
            'AMAT': { var: 10.059936, price: 170.88, sector: 'Technology', description: 'Applied Materials Inc', atr_d1: 3.602857, atr_w1: 12.180714, atr_mn1: 33.019286 },
            'AMD': { var: 6.976346, price: 161.21, sector: 'Technology', description: 'Advanced Micro Devices Inc', atr_d1: 5.377857, atr_w1: 15.418571, atr_mn1: 30.767143 },
            'AMGN': { var: 5.10051, price: 274.51, sector: 'Healthcare', description: 'Amgen Inc', atr_d1: 4.724286, atr_w1: 13.56, atr_mn1: 34.034286 },
            'AMKR': { var: 0.728644, price: 25.69, sector: 'Technology', description: 'Amkor Technology Inc', atr_d1: 0.616429, atr_w1: 1.660714, atr_mn1: 5.196429 },
            'AMZN': { var: 6.705823, price: 231.43, sector: 'Consumer Cyclical', description: 'Amazon.com Inc', atr_d1: 4.532143, atr_w1: 11.352143, atr_mn1: 26.707143 },
            'APA': { var: 1.097495, price: 22.93, sector: 'Energy', description: 'APA Corp', atr_d1: 0.882857, atr_w1: 1.802143, atr_mn1: 4.528571 },
            'APLS': { var: 0.859183, price: 24.50, sector: 'Healthcare', description: 'Apellis Pharmaceuticals Inc', atr_d1: 0.982143, atr_w1: 2.286429, atr_mn1: 6.626429 },
            'ARCC': { var: 0.183645, price: 21.32, sector: 'Financial', description: 'Ares Capital Corp', atr_d1: 0.186429, atr_w1: 0.601429, atr_mn1: 1.657143 },
            'ARWR': { var: 2.293754, price: 28.67, sector: 'Healthcare', description: 'Arrowhead Pharmaceuticals Inc', atr_d1: 1.575714, atr_w1: 2.700714, atr_mn1: 5.73 },
            'AVGO': { var: 21.815319, price: 364.14, sector: 'Technology', description: 'Broadcom Inc', atr_d1: 14.567143, atr_w1: 23.23, atr_mn1: 43.927143 },
            'AXON': { var: 26.586912, price: 761.25, sector: 'Industrials', description: 'Axon Enterprise Inc', atr_d1: 20.775714, atr_w1: 63.984286, atr_mn1: 122.238571 },
            'AZTA': { var: 1.226524, price: 29.99, sector: 'Technology', description: 'Azenta Inc', atr_d1: 1.187857, atr_w1: 3.426429, atr_mn1: 9.201429 },
            'BIIB': { var: 5.164324, price: 143.67, sector: 'Healthcare', description: 'Biogen Inc', atr_d1: 4.334286, atr_w1: 9.043571, atr_mn1: 19.869286 },
            'BKNG': { var: 98.396947, price: 5562.61, sector: 'Consumer Cyclical', description: 'Booking Holdings Inc', atr_d1: 109.538571, atr_w1: 241.585714, atr_mn1: 600.279286 },
            'BL': { var: 1.438865, price: 54.40, sector: 'Technology', description: 'Blackline Inc', atr_d1: 1.501429, atr_w1: 3.612143, atr_mn1: 8.332857 },
            'BLDR': { var: 7.350413, price: 140.57, sector: 'Industrials', description: 'Builders FirstSource Inc', atr_d1: 4.848571, atr_w1: 12.367143, atr_mn1: 30.798571 },
            'BLK': { var: 21.833462, price: 1114.58, sector: 'Financial', description: 'BlackRock Inc', atr_d1: 16.731429, atr_w1: 45.852857, atr_mn1: 106.527857 },
            'BMRN': { var: 1.502858, price: 53.18, sector: 'Healthcare', description: 'BioMarin Pharmaceutical Inc', atr_d1: 1.56, atr_w1: 3.18, atr_mn1: 9.498571 },
            'BRKR': { var: 2.001646, price: 32.15, sector: 'Healthcare', description: 'Bruker Corp', atr_d1: 1.555714, atr_w1: 4.545714, atr_mn1: 9.886429 },
            'CACC': { var: 24.377561, price: 503.45, sector: 'Financial', description: 'Credit Acceptance Corp', atr_d1: 19.306429, atr_w1: 40.337857, atr_mn1: 81.642857 },
            'CAR': { var: 5.127566, price: 153.12, sector: 'Industrials', description: 'Avis Budget Group Inc', atr_d1: 4.892857, atr_w1: 19.710714, atr_mn1: 30.153571 },
            'CASY': { var: 12.775113, price: 555.43, sector: 'Consumer Defensive', description: 'Casey\'s General Stores Inc', atr_d1: 11.993571, atr_w1: 23.346429, atr_mn1: 47.490714 },
            'CC': { var: 0.845896, price: 17.26, sector: 'Basic Materials', description: 'Chemours Co/The', atr_d1: 0.61, atr_w1: 1.755714, atr_mn1: 4.012143 },
            'CDNS': { var: 13.933371, price: 351.71, sector: 'Technology', description: 'Cadence Design Systems Inc', atr_d1: 10.38, atr_w1: 19.456429, atr_mn1: 47.827143 },
            'CDW': { var: 3.794821, price: 163.29, sector: 'Technology', description: 'CDW Corp/DE', atr_d1: 4.102857, atr_w1: 8.898571, atr_mn1: 25.342857 },
            'CG': { var: 2.018319, price: 66.83, sector: 'Financial', description: 'Carlyle Group Inc/The', atr_d1: 1.701429, atr_w1: 4.454286, atr_mn1: 9.703571 },
            'CGNX': { var: 1.052741, price: 44.18, sector: 'Technology', description: 'Cognex Corp', atr_d1: 0.872857, atr_w1: 2.655714, atr_mn1: 6.591429 },
            'CHDN': { var: 2.317884, price: 96.12, sector: 'Consumer Cyclical', description: 'Churchill Downs Inc', atr_d1: 2.643571, atr_w1: 6.137143, atr_mn1: 13.745 },
            'CHRW': { var: 2.523881, price: 133.43, sector: 'Industrials', description: 'CH Robinson Worldwide Inc', atr_d1: 2.528571, atr_w1: 6.495, atr_mn1: 12.755714 },
            'CHTR': { var: 5.630847, price: 260.95, sector: 'Communication Services', description: 'Charter Communications Inc', atr_d1: 7.092143, atr_w1: 26.04, atr_mn1: 61.119286 },
            'CINF': { var: 2.914682, price: 155.13, sector: 'Financial', description: 'Cincinnati Financial Corp', atr_d1: 2.531429, atr_w1: 6.296429, atr_mn1: 15.143571 },
            'CMCSA': { var: 0.529106, price: 32.62, sector: 'Communication Services', description: 'Comcast Corp', atr_d1: 0.607143, atr_w1: 1.470714, atr_mn1: 4.021429 },
            'CME': { var: 3.872799, price: 258.95, sector: 'Financial', description: 'CME Group Inc', atr_d1: 3.818571, atr_w1: 8.935714, atr_mn1: 19.03 },
            'COLM': { var: 1.618237, price: 54.27, sector: 'Consumer Cyclical', description: 'Columbia Sportswear Co', atr_d1: 1.602143, atr_w1: 4.367143, atr_mn1: 10.575714 },
            'COST': { var: 18.744951, price: 960.53, sector: 'Consumer Defensive', description: 'Costco Wholesale Corp', atr_d1: 12.347143, atr_w1: 30.489286, atr_mn1: 94.797143 },
            'CPRT': { var: 1.135637, price: 47.63, sector: 'Industrials', description: 'Copart Inc', atr_d1: 1.14, atr_w1: 1.967857, atr_mn1: 6.557143 },
            'CROX': { var: 3.03683, price: 77.53, sector: 'Consumer Cyclical', description: 'Crocs Inc', atr_d1: 3.085714, atr_w1: 9.543571, atr_mn1: 22.795 },
            'CRWD': { var: 13.872598, price: 444.86, sector: 'Technology', description: 'Crowdstrike Holdings Inc', atr_d1: 12.667143, atr_w1: 29.787857, atr_mn1: 80.884286 },
            'CSGP': { var: 2.023296, price: 89.02, sector: 'Real Estate', description: 'CoStar Group Inc', atr_d1: 1.909286, atr_w1: 5.054286, atr_mn1: 10.435714 },
            'CSX': { var: 0.891049, price: 32.51, sector: 'Industrials', description: 'CSX Corp', atr_d1: 0.690714, atr_w1: 1.618571, atr_mn1: 3.371429 },
            'CTAS': { var: 3.775766, price: 199.82, sector: 'Industrials', description: 'Cintas Corp', atr_d1: 3.532143, atr_w1: 7.764286, atr_mn1: 20.752857 },

            // Add popular symbols that might not be in latest CSV
            'AAPL': { var: 8.50, price: 220.25, sector: 'Technology', description: 'Apple Inc', atr_d1: 4.20, atr_w1: 8.50, atr_mn1: 22.30 },
            'MSFT': { var: 7.20, price: 420.12, sector: 'Technology', description: 'Microsoft Corporation', atr_d1: 6.80, atr_w1: 15.20, atr_mn1: 35.80 },
            'GOOGL': { var: 9.80, price: 165.45, sector: 'Technology', description: 'Alphabet Inc Class A', atr_d1: 3.20, atr_w1: 7.80, atr_mn1: 18.50 },
            'TSLA': { var: 12.30, price: 254.32, sector: 'Consumer Cyclical', description: 'Tesla Inc', atr_d1: 8.90, atr_w1: 22.50, atr_mn1: 55.20 },
            'NVDA': { var: 35.20, price: 875.42, sector: 'Technology', description: 'NVIDIA Corporation', atr_d1: 25.80, atr_w1: 65.30, atr_mn1: 145.20 },
            'META': { var: 11.10, price: 495.75, sector: 'Technology', description: 'Meta Platforms Inc', atr_d1: 12.50, atr_w1: 28.90, atr_mn1: 68.50 },
            'NFLX': { var: 8.90, price: 445.67, sector: 'Communication Services', description: 'Netflix Inc', atr_d1: 9.20, atr_w1: 21.80, atr_mn1: 52.30 },
            'SPY': { var: 4.20, price: 545.80, sector: 'ETF', description: 'SPDR S&P 500 ETF Trust', atr_d1: 6.20, atr_w1: 12.50, atr_mn1: 28.80 },
            'QQQ': { var: 5.10, price: 470.25, sector: 'ETF', description: 'Invesco QQQ Trust', atr_d1: 8.30, atr_w1: 18.20, atr_mn1: 42.50 }
        };

        function lookupSymbol() {
            const symbol = document.getElementById('symbol-lookup').value.toUpperCase().trim();
            const infoDiv = document.getElementById('symbol-info');
            const detailsDiv = document.getElementById('symbol-details');

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }

            if (varData[symbol]) {
                const data = varData[symbol];
                detailsDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong style="color: #00ff00;">${symbol}</strong> - ${data.description}<br>
                            <span style="color: #00cc00;">Sector:</span> ${data.sector}<br>
                            <span style="color: #00cc00;">Current Price:</span> $${data.price}
                        </div>
                        <div>
                            <span style="color: #00cc00;">1-Day VaR (95%):</span> $${data.var}<br>
                            <span style="color: #00cc00;">VaR %:</span> ${(data.var/data.price*100).toFixed(2)}%<br>
                            <button onclick="addSymbolToPortfolio('${symbol}')" style="background: #003300; color: #00ff00; border: 1px solid #00ff00; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px;">Add to Portfolio</button>
                        </div>
                    </div>
                `;
                infoDiv.style.display = 'block';
            } else {
                detailsDiv.innerHTML = `<div style="color: #ffaa00;">‚ö†Ô∏è Symbol "${symbol}" not found in database. Using VaR explorer data from latest market session.</div>`;
                infoDiv.style.display = 'block';
            }
        }

        function addSymbolToPortfolio(symbol) {
            const data = varData[symbol];
            if (!data) return;

            const tbody = document.getElementById('portfolio-positions');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" value="${symbol}" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                <td><input type="number" placeholder="100" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                <td><input type="number" value="${data.price}" step="0.01" style="width: 70px;" onchange="updatePositionValue(this)"></td>
                <td class="value-display">-</td>
                <td class="var-display">$${data.var}</td>
                <td class="weight-display">-</td>
                <td><button class="remove-btn" onclick="removePosition(this)">√ó</button></td>
            `;
            tbody.appendChild(newRow);

            // Hide symbol info
            document.getElementById('symbol-info').style.display = 'none';
            document.getElementById('symbol-lookup').value = '';
        }

        function addPosition() {
            const tbody = document.getElementById('portfolio-positions');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="SYMBOL" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                <td><input type="number" placeholder="100" style="width: 60px;" onchange="updatePositionValue(this)"></td>
                <td><input type="number" placeholder="150.00" step="0.01" style="width: 70px;" onchange="updatePositionValue(this)"></td>
                <td class="value-display">-</td>
                <td class="var-display">-</td>
                <td class="weight-display">-</td>
                <td><button class="remove-btn" onclick="removePosition(this)">√ó</button></td>
            `;
            tbody.appendChild(newRow);
        }

        function updatePositionValue(input) {
            const row = input.closest('tr');
            const inputs = row.querySelectorAll('input');
            const symbol = inputs[0].value.toUpperCase().trim();
            const shares = parseFloat(inputs[1].value) || 0;
            const price = parseFloat(inputs[2].value) || 0;

            const valueDisplay = row.querySelector('.value-display');
            const varDisplay = row.querySelector('.var-display');

            const value = shares * price;
            valueDisplay.textContent = value > 0 ? `$${value.toLocaleString()}` : '-';

            // Update VaR if symbol is found in database
            if (symbol && varData[symbol]) {
                const positionVar = shares * varData[symbol].var;
                varDisplay.textContent = `$${positionVar.toFixed(2)}`;

                // Auto-fill price if empty
                if (price === 0) {
                    inputs[2].value = varData[symbol].price;
                    updatePositionValue(inputs[2]); // Recalculate
                }
            } else if (symbol) {
                varDisplay.textContent = 'Unknown';
            }
        }

        function removePosition(button) {
            const row = button.closest('tr');
            if (document.getElementById('portfolio-positions').children.length > 1) {
                row.remove();
            }
        }

        function calculatePortfolioVaR() {
            const confidence = parseFloat(document.getElementById('pf-confidence').value);
            const timeHorizon = parseInt(document.getElementById('pf-time-horizon').value);
            const rows = document.querySelectorAll('#portfolio-positions tr');

            let positions = [];
            let totalValue = 0;
            let totalVaR = 0;

            for (let row of rows) {
                const inputs = row.querySelectorAll('input');
                const symbol = inputs[0].value.toUpperCase().trim();
                const shares = parseFloat(inputs[1].value) || 0;
                const price = parseFloat(inputs[2].value) || 0;

                if (symbol && shares && price) {
                    const value = shares * price;
                    let positionVaR = 0;
                    let varPerShare = 0;

                    // Use real VaR data if available
                    if (varData[symbol]) {
                        varPerShare = varData[symbol].var;
                        positionVaR = shares * varPerShare;
                    } else {
                        // Fallback: estimate VaR as 2% of position value for unknown symbols
                        positionVaR = value * 0.02;
                        varPerShare = price * 0.02;
                    }

                    positions.push({
                        symbol,
                        shares,
                        price,
                        value,
                        positionVaR,
                        varPerShare,
                        hasRealData: !!varData[symbol]
                    });
                    totalValue += value;
                    totalVaR += positionVaR;
                }
            }

            if (positions.length === 0) {
                alert('Please add at least one position');
                return;
            }

            // Update weights display
            positions.forEach((pos, index) => {
                const weight = (pos.value / totalValue * 100).toFixed(1);
                rows[index].querySelector('.weight-display').textContent = weight + '%';
                pos.weight = parseFloat(weight);
            });

            // Calculate portfolio VaR (simplified linear aggregation - no correlation)
            // For different confidence levels, adjust the base VaR
            const confidenceAdjustment = confidence === 95 ? 1.0 : confidence === 99 ? 1.4 : 1.8;
            const timeAdjustment = Math.sqrt(timeHorizon);
            const adjustedPortfolioVaR = totalVaR * confidenceAdjustment * timeAdjustment;

            let output = `
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Total Portfolio Value:</div>
                    <div class="result-value">$${totalValue.toLocaleString()}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Portfolio VaR (${confidence}%, ${timeHorizon} day${timeHorizon > 1 ? 's' : ''}):</div>
                    <div class="result-value">$${adjustedPortfolioVaR.toFixed(2)} (${(adjustedPortfolioVaR/totalValue*100).toFixed(2)}% of portfolio)</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Daily VaR (estimated):</div>
                    <div class="result-value">$${(totalVaR * confidenceAdjustment).toFixed(2)} (${(totalVaR * confidenceAdjustment/totalValue*100).toFixed(2)}% of portfolio)</div>
                </div>
            `;

            output += `<h4 style="color: #00ff00; margin: 20px 0 10px 0;">Position Breakdown:</h4>`;
            for (let pos of positions) {
                const dataSource = pos.hasRealData ? 'üìä' : '‚ö†Ô∏è';
                const dataNote = pos.hasRealData ? 'Real VaR data' : 'Estimated (2%)';
                output += `
                    <div style="margin-bottom: 8px; padding: 8px; background: rgba(0,255,0,0.1); border-left: 2px solid #00ff00;">
                        <strong>${pos.symbol}</strong> ${dataSource} ${dataNote}<br>
                        ${pos.shares.toLocaleString()} shares √ó $${pos.price} = $${pos.value.toLocaleString()} (${pos.weight}%)<br>
                        Position VaR: $${pos.positionVaR.toFixed(2)} (VaR/share: $${pos.varPerShare.toFixed(2)})
                    </div>
                `;
            }

            const realDataCount = positions.filter(p => p.hasRealData).length;
            const estimatedCount = positions.length - realDataCount;

            output += `
                <div class="warning-text" style="margin-top: 15px;">
                    üìä ${realDataCount} position${realDataCount !== 1 ? 's' : ''} using real VaR data from market analysis<br>
                    ${estimatedCount > 0 ? `‚ö†Ô∏è ${estimatedCount} position${estimatedCount !== 1 ? 's' : ''} using estimated VaR (2% of position value)<br>` : ''}
                    ‚ö†Ô∏è This calculation assumes no correlation between positions. Actual portfolio VaR may be higher during market stress when correlations increase.
                </div>
            `;

            document.getElementById('pf-output').innerHTML = output;
            document.getElementById('pf-results').classList.add('show');
        }

        function calculateRiskReturn() {
            const returnsText = document.getElementById('rr-returns').value;
            const riskFreeRate = parseFloat(document.getElementById('rr-risk-free').value) || 0;
            const periodsPerYear = parseInt(document.getElementById('rr-periods').value);

            if (!returnsText) {
                alert('Please enter returns data');
                return;
            }

            const returns = returnsText.split(',').map(r => parseFloat(r.trim())).filter(r => !isNaN(r));

            if (returns.length < 2) {
                alert('Please enter at least 2 return values');
                return;
            }

            // Calculate metrics
            const meanReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((sum, r) => sum + Math.pow(r - meanReturn, 2), 0) / (returns.length - 1);
            const stdDev = Math.sqrt(variance);

            // Annualized metrics
            const annualizedReturn = meanReturn * periodsPerYear;
            const annualizedVolatility = stdDev * Math.sqrt(periodsPerYear);
            const excessReturn = annualizedReturn - riskFreeRate;
            const sharpeRatio = excessReturn / annualizedVolatility;

            // Drawdown calculation
            let peak = returns[0];
            let maxDrawdown = 0;
            let currentDrawdown = 0;

            for (let i = 1; i < returns.length; i++) {
                const cumReturn = returns.slice(0, i+1).reduce((a, b) => a + b, 0);
                if (cumReturn > peak) {
                    peak = cumReturn;
                    currentDrawdown = 0;
                } else {
                    currentDrawdown = peak - cumReturn;
                    maxDrawdown = Math.max(maxDrawdown, currentDrawdown);
                }
            }

            const output = `
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Sample Size:</div>
                    <div class="result-value">${returns.length} periods</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Mean Return (per period):</div>
                    <div class="result-value">${meanReturn.toFixed(3)}%</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Volatility (per period):</div>
                    <div class="result-value">${stdDev.toFixed(3)}%</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Annualized Return:</div>
                    <div class="result-value">${annualizedReturn.toFixed(2)}%</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Annualized Volatility:</div>
                    <div class="result-value">${annualizedVolatility.toFixed(2)}%</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Sharpe Ratio:</div>
                    <div class="result-value">${sharpeRatio.toFixed(3)}</div>
                </div>
                <div style="margin-bottom: 15px;">
                    <div class="result-label">Maximum Drawdown:</div>
                    <div class="result-value">${maxDrawdown.toFixed(2)}%</div>
                </div>
                <div class="warning-text">‚ö†Ô∏è Past performance does not guarantee future results. These metrics are based on historical data only.</div>
            `;

            document.getElementById('rr-output').innerHTML = output;
            document.getElementById('rr-results').classList.add('show');
        }

        // Symbol Lookup Functions
        function performSymbolLookup() {
            const symbol = document.getElementById('lookup-symbol').value.toUpperCase().trim();
            if (symbol && varData[symbol]) {
                displaySymbolInfo(symbol, varData[symbol]);
            } else if (symbol) {
                document.getElementById('lookup-output').innerHTML = `
                    <div style="color: #ff8800; padding: 15px; border: 1px solid #ff8800; border-radius: 4px;">
                        <h4>‚ö†Ô∏è Symbol "${symbol}" Not Found</h4>
                        <p>This symbol is not in our current database. Our database contains ${Object.keys(varData).length} symbols from the latest Darwinex session.</p>
                        <p style="color: #ffaa00;">Try searching for: ${getRandomSymbols().join(', ')}</p>
                    </div>
                `;
            }
        }

        function quickLookup(symbol) {
            document.getElementById('lookup-symbol').value = symbol;
            performSymbolLookup();
        }

        function displaySymbolInfo(symbol, data) {
            const output = `
                <div style="padding: 15px; border: 1px solid #00ff00; border-radius: 4px; background: rgba(0,255,0,0.05);">
                    <h3 style="color: #00ff00; margin: 0 0 15px 0;">${symbol} - ${data.description}</h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <h4 style="color: #00cc00; margin: 0 0 8px 0;">üí∞ Price & Risk Data</h4>
                            <div><strong>Current Price:</strong> $${data.price}</div>
                            <div><strong>VaR (1 lot):</strong> $${data.var.toFixed(6)}</div>
                            <div><strong>VaR %:</strong> ${(data.var / data.price * 100).toFixed(3)}%</div>
                            <div><strong>Sector:</strong> ${data.sector}</div>
                        </div>
                        <div>
                            <h4 style="color: #00cc00; margin: 0 0 8px 0;">üìä ATR Values</h4>
                            ${data.atr_d1 ? `<div><strong>ATR Daily:</strong> $${data.atr_d1.toFixed(6)}</div>` : ''}
                            ${data.atr_w1 ? `<div><strong>ATR Weekly:</strong> $${data.atr_w1.toFixed(6)}</div>` : ''}
                            ${data.atr_mn1 ? `<div><strong>ATR Monthly:</strong> $${data.atr_mn1.toFixed(6)}</div>` : ''}
                            ${!data.atr_d1 ? '<div style="color: #ff8800;">ATR data not available</div>' : ''}
                        </div>
                    </div>

                    <div style="margin: 15px 0; padding: 10px; background: rgba(255,255,0,0.1); border: 1px solid #ffff00; border-radius: 4px;">
                        <h4 style="color: #ffff00; margin: 0 0 8px 0;">üéØ Trading Suggestions</h4>
                        ${data.atr_d1 ? `
                            <div><strong>Stop Loss (2.5x ATR D1):</strong> $${(data.price - (data.atr_d1 * 2.5)).toFixed(2)} (${((data.atr_d1 * 2.5) / data.price * 100).toFixed(2)}% below current)</div>
                            <div><strong>Stop Loss (2x ATR D1):</strong> $${(data.price - (data.atr_d1 * 2)).toFixed(2)} (${((data.atr_d1 * 2) / data.price * 100).toFixed(2)}% below current)</div>
                        ` : ''}
                        <div style="margin-top: 8px; color: #cccc00;">üí° Use Stop Loss Calculator for custom risk management</div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="quick-symbol-btn" onclick="useInStopLoss('${symbol}')">üìä Use in Stop Loss Calc</button>
                        <button class="quick-symbol-btn" onclick="useInPortfolio('${symbol}')">üìà Add to Portfolio</button>
                    </div>
                </div>
            `;

            document.getElementById('lookup-output').innerHTML = output;
        }

        function filterSymbols() {
            const selectedSector = document.getElementById('lookup-filter').value;
            if (!selectedSector) {
                showAllSymbols();
                return;
            }

            const filtered = Object.entries(varData).filter(([symbol, data]) =>
                data.sector === selectedSector
            );

            let output = `
                <div style="padding: 15px; border: 1px solid #00ff00; border-radius: 4px;">
                    <h3 style="color: #00ff00; margin: 0 0 15px 0;">${selectedSector} Sector (${filtered.length} symbols)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
            `;

            filtered.forEach(([symbol, data]) => {
                output += `
                    <div style="padding: 8px; background: rgba(0,255,0,0.1); border: 1px solid #00aa00; border-radius: 4px; cursor: pointer;" onclick="quickLookup('${symbol}')">
                        <strong>${symbol}</strong><br>
                        <small>$${data.price} | VaR: $${data.var.toFixed(3)}</small><br>
                        <small style="color: #00aa00;">${data.description.length > 25 ? data.description.substring(0, 25) + '...' : data.description}</small>
                    </div>
                `;
            });

            output += `</div></div>`;
            document.getElementById('lookup-output').innerHTML = output;
        }

        function showAllSymbols() {
            const symbols = Object.entries(varData);
            let output = `
                <div style="padding: 15px; border: 1px solid #00ff00; border-radius: 4px;">
                    <h3 style="color: #00ff00; margin: 0 0 15px 0;">All Available Symbols (${symbols.length} total)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto;">
            `;

            symbols.forEach(([symbol, data]) => {
                output += `
                    <div style="padding: 6px; background: rgba(0,255,0,0.1); border: 1px solid #00aa00; border-radius: 3px; cursor: pointer; font-size: 0.9em;" onclick="quickLookup('${symbol}')">
                        <strong>${symbol}</strong> | $${data.price}<br>
                        <small style="color: #00aa00;">${data.sector}</small>
                    </div>
                `;
            });

            output += `</div></div>`;
            document.getElementById('lookup-output').innerHTML = output;
        }

        function getRandomSymbols() {
            const symbols = Object.keys(varData);
            const shuffled = symbols.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, 5);
        }

        function useInStopLoss(symbol) {
            selectCalculator('stoploss');
            document.getElementById('sl-symbol').value = symbol;
            autoFillStopLossData();
        }

        function useInPortfolio(symbol) {
            selectCalculator('portfolio');
            document.getElementById('symbol-lookup').value = symbol;
            lookupSymbol();
        }
    </script>
</body>
</html>